#!/usr/bin/env bash

# Name: rclone_sync - rclone sync to bucket s3
# Usage:
#     rclone_sync [ -h|--help ] [ -H|--Help ]
#         [ -o|--options <rclone_options> ]
#         <local_path> <remote:bucket/path>
# Options:
#     -h|--help                     : print usage
#     -H|--Help                     : print description
#     -o|--options <rclone_options> : rclone options
#     <local_path>                  : local path to sync
#     <remote:bucket/path>          : remote path
# Author: Marco Broglia (marco.broglia@mutex.it)
# Date: 2025.09.15

#
# vars
#

# env

set -euo pipefail

home=$(dirname $(dirname $0))

project=$(basename $home)
progname=${0##*/}

command="$0"; [ $# -gt 0 ] && command="$command $*"

# dirs & files

conf=$home/etc/rclone.conf
logf=$home/log/$project.log

# cmds

rclone=${RCLONE:-rclone}

#
# funcs
#

now()   { date '+%Y.%m.%d-%H:%M:%S'; }
log()   { echo "$(now) [$progname:$$] $*" >> $logf; }
usage() { echo "$help"; }

#
# opts
#

# default rclone options

OPTS=(--config $conf)               # rclone config file
OPTS+=(--local-no-check-updated)    # skip check of local files during upload
OPTS+=(--stats 1h)                  # print stats every hour
OPTS+=(--update)                    # skip files newer on destination
OPTS+=(--use-server-modtime)        # use server modtime instead of metadata
OPTS+=(--verbose)                   # more detailed output

# my options

help=$(sed -n '/^# Usage:/,/^# [^ ]/p' $0 | sed '$d;s/^# //')
Help=$(sed -n '/^# Name:/{:a;/^#/{p;n;ba}}' $0 | sed 's/^# //')

GETOPTS=$(getopt -o hHo: -l help,Help,options -- "$@") || { usage; exit 1; }
eval set -- "$GETOPTS"

while :; do
    case "$1" in
        -h|--help) echo "$help"; exit 0 ;;
        -H|--Help) echo "$Help"; exit 0 ;;
        -o|--options) eval "args=($2)"; MYOPTS+=("${args[@]}"); shift 2 ;;
        --) shift; break ;;
        *) usage; exit 2 ;;
    esac
done
[ $# != 2 ] && { usage; exit 3; }

# local and remote paths

lpath=$1 rpath=$2

#
# main
#

# start

log "start '$progname' ($command)"

# opts

log "rclone options: '${OPTS[@]}'"
log "rclone extra options: '${MYOPTS[@]}'"
opts=("${OPTS[@]}" "${MYOPTS[@]}")

# run

log "run '$rclone sync ${opts[@]} $lpath $rpath'"
#$rclone sync ${opts[@]} $lpath $rpath
sleep 1
log "sync '$lpath' -> '$rpath' done"

# end

log "end '$progname'"
exit 0
